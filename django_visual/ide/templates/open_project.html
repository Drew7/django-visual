{% extends 'base.html' %}

{% block css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.3.5/split.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.4/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.4/theme-monokai.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.4/mode-python.js"></script>

<style>
    /* CSS Goes Here */
    .split {-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;overflow-y: auto;overflow-x: hidden;}
    .gutter {background-color: transparent;background-repeat: no-repeat;background-position: 50%;}
    .gutter.gutter-horizontal {cursor: col-resize;background-image:  url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg=='); }
    .gutter.gutter-vertical {cursor: row-resize;background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII='); }
    .split.split-horizontal, .gutter.gutter-horizontal { height: 100%;float: left;}

    /* replace folder icons with another image, remove leaf image */        
    li.jstree-open > a .jstree-icon {background:url("/static/imgs/folder.png") 0px 0px no-repeat !important;}
    li.jstree-closed > a .jstree-icon {background:url("/static/imgs/folder.png") 0px 0px no-repeat !important;}
    li.jstree-leaf > a .jstree-icon {background:url("/static/imgs/file.png") 0px 0px no-repeat !important;}

    #navigator_column {
    	padding-top: 55px;
    }
    
    #center_column {
    	background:#eee;
    	padding-top: 55px;
    }

    #properties_column {
    	padding-top: 55px;
    }
</style>
{% endblock %}

{% block body %}
<div class="row no-gutters h-100">
	<nav class="navbar navbar-expand-md navbar-light fixed-top bg-light border-bottom">
	  	<a class="navbar-brand" href="#">
	        <img src="/static/imgs/vdj.png" alt="VDj" style="width: 1.5em" class="float-left" />
	        Visual Django
	    </a>

	    <a class="nav-link disabled" href="#">|</a>

	    <a class="navbar-brand" href="#">
	    	Project: {{project_id}}
	    </a>
	    
	    <a class="btn btn-success btn-sm" href="#" target=_new>
          Run
        </a>

	    <div class="collapse navbar-collapse" id="navbarCollapse">
	      <ul class="navbar-nav mr-auto">
	      	<li class="nav-item">
		    	<a class="nav-link disabled" href="#">|</a>
		  	</li>
	        <li class="nav-item dropdown">
			    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">File</a>
			    <div class="dropdown-menu">
			      <a class="dropdown-item" href="/">Open Project</a>
			      <a class="dropdown-item" href="/#v-pills-new">Create Project</a>
			      <div class="dropdown-divider"></div>
			      <a class="dropdown-item" href="https://docs.djangoproject.com">Django Help</a>
			      <div class="dropdown-divider"></div>
			      <a class="dropdown-item" href="#">Exit</a>
			    </div>
			</li>
	        
	      </ul>

	      <form class="form-inline mt-2 mt-md-0">
	        <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
	        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
	      </form>
	    </div>
	</nav>

    <div id="navigator_column" class="col">
    	<ul class="nav nav-tabs">
		  <li class="nav-item">
		    <a class="nav-link active bg-light" role="tab">Project Navigator</a>
		  </li>
		</ul>
		<div class="card border-0">
	        <!-- https://www.jstree.com/ -->
	        <div class="card-block px-2">
		    	<div id="project_tree">
		    		<ul>
			    	{% for item, value in project_tree.items %}
			    		<li>{{item}}
			    		{% if value.items %}
							<ul>
								{% for item, value in value.items %}
			    					<li data-path="{{value}}">{{item}}
			    					{% if value.items %}
										<ul>
											{% for item, value in value.items %}
			    								<li data-path="{{value}}">{{item}}
			    								{% if value.items %}
													<ul>
														{% for item, value in value.items %}
			    											<li data-path="{{value}}">{{item}}</li>	
			    										{% endfor %}
													</ul>
												{% endif %}
												</li>
			    							{% endfor %}
										</ul>
									{% endif %}
									</li>
			    				{% endfor %}
							</ul>
						{% endif %}
						</li>
					{% endfor %}
					</ul>
				</div>
			</div>
			<!-- <div class="card-footer">
	            Edit
	        </div> -->
		</div>

    </div>
    
    <div id="center_column" class="col">
    	<!-- Editor Area -->
    	<ul class="nav nav-tabs" id="center_column_tabs" role="tablist">
		  <li class="nav-item">
		    <a href="#welcome-editor" class="nav-link active" id="welcome-tab" data-toggle="tab" role="tab" aria-controls="welcome-editor" aria-selected="true">Welcome</a>
		  </li>
		  <li class="nav-item">
		    <a href="#aaa-editor" class="nav-link" id="aaa-tab" data-toggle="tab" role="tab" aria-controls="aaa-editor" aria-selected="true">AAA</a>
		  </li>
		</ul>
		<div class="tab-content h-100" id="center_column_tabs_content">
		  <div class="tab-pane fade show active h-100" id="welcome-editor" role="tabpanel" aria-labelledby="welcome-tab">
		  	<iframe style="height: 100%; width: 100%" src="https://vsergeyev.github.io/django-visual/"></iframe>
		  </div>
		  <div class="tab-pane fade h-100" id="aaa-editor" role="tabpanel" aria-labelledby="aaa-tab">
		  	Bha ba ba!!!
		  </div>
		</div>
    </div>

    <div id="properties_column" class="col">
    	
    	<div class="card">
    		<ul class="nav nav-tabs">
			  <li class="nav-item">
			    <a class="nav-link active bg-light" role="tab">Applications</a>
			  </li>
			</ul>
	        <div class="card-block px-2">
		    	<div class="list-group list-group-flush">
		    	{% for item in project_apps %}
				  <a href="#" class="list-group-item list-group-item-action">
				    {{item}}
				  </a>
				{% endfor %}
				</div>
			</div>
			<!-- <div class="card-footer">
	            Edit
	        </div> -->
		</div>

		<div class="card">
	        <ul class="nav nav-tabs">
			  <li class="nav-item">
			    <a class="nav-link active bg-light" role="tab">Databases</a>
			  </li>
			</ul>
	        <div class="card-block px-2">
		    	<div class="list-group list-group-flush">
		    	{% for label, item in project_databases.items %}
				  <div href="#" class="list-group-item list-group-item-action">
				    {{label}}

					<div class="dropdown float-right">
					  <button class="badge badge-info badge-pill btn btn-info dropdown-toggle btn-sm" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					    Info
					  </button>
					  <div class="dropdown-menu">
					  	{% for key, value in item.iteritems %} 
					    	<a class="dropdown-item small" href="#">{{key}}: {{value}}</a>
					    {% endfor %}
					  </div>
					</div>
				</div>
				{% endfor %}
				</div>
			</div>
			<!-- <div class="card-footer">
	            Edit
	        </div> -->
		</div>

		<div class="card">
	        <ul class="nav nav-tabs">
			  <li class="nav-item">
			    <a class="nav-link active bg-light" role="tab">URLs</a>
			  </li>
			</ul>
	        <div class="card-block px-2">
		    	<div class="list-group list-group-flush">
		    	{% for item in project_urls %}
				  <a href="#" class="list-group-item list-group-item-action">
				    {{item}}
				  </a>
				{% endfor %}
				
				<a href="#" class="list-group-item list-group-item-action">
				  Add</a>
				</div>
			</div>
			<!-- <div class="card-footer">
	            Edit
	        </div> -->
		</div>

    </div>
</div>

<script>
    /* JS Goes Here */
    var splitobj = Split(["#navigator_column","#center_column","#properties_column"], {
        elementStyle: function (dimension, size, gutterSize) { 
            $(window).trigger('resize'); // Optional
            return {'flex-basis': 'calc(' + size + '% - ' + gutterSize + 'px)'}
        },
        gutterStyle: function (dimension, gutterSize) { return {'flex-basis':  gutterSize + 'px'} },
        sizes: [20,60,20],
        minSize: 50,
        gutterSize: 6,
        cursor: 'col-resize'
    });

    $('#project_tree').jstree().on('ready.jstree', function(){
    	$.jstree.defaults.core.multiple = false;

    	$(this).jstree('open_all');

    	$(this).on("changed.jstree", function (e, data) {
			var label = $("#" + data.selected[0]).text(),
				path = $("#" + data.selected[0]).attr("data-path");

			//console.log(label);

			$.get("/ide/open_file/", {"path": path}, function(data) {
				//console.log(data);

				var ts = + new Date();

				$('<li class="nav-item">'
		    	  + '<a href="#editor-' + ts + '" class="nav-link" id="tab-' + ts + '" data-toggle="tab" role="tab" '
		    	  + 'aria-controls="editor-' + ts + '">' + label + '</a>'
		  		  + '</li>').appendTo("#center_column_tabs");

				$('<div class="tab-pane fade h-100" id="editor-' + ts + '" role="tabpanel" '
				  + 'aria-labelledby="tab-' + ts + '">'
				  + '<div class="code-editor" id="code-editor-' + ts + '">' + data + '</div>'
				  + '</div>').appendTo('#center_column_tabs_content');

				$('#tab-' + ts).tab('show');

				var PythonMode = ace.require("ace/mode/python").Mode;
				var editor = ace.edit('code-editor-' + ts);

				editor.setTheme("ace/theme/monokai");
				editor.session.setMode(new PythonMode());
				editor.setFontSize(14);
				//$('#tab-' + ts + ' li:last-child a').tab('show');
			});
		});
    });
</script>
{% endblock %}