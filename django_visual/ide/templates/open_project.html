{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="/static/css/jstree.3.2.1.style.min.css" />

<script src="/static/js/split.1.3.5.min.js"></script>
<script src="/static/js/jstree.3.2.1.min.js"></script>

<script src="/static/js/ace.1.4.4.js"></script>
<script src="/static/js/ace.theme-monokai.1.4.4.js"></script>
<script src="/static/js/ace.mode-python.1.4.4.js"></script>

<script src="/static/js/sql.js"></script>

<script src="/static/js/editor_code.js"></script>
<script src="/static/js/editor_sqlite3.js"></script>
<script src="/static/js/ide.js"></script>
{% endblock %}

{% block body %}
<div class="row no-gutters full-height">
	<nav class="navbar navbar-expand-md navbar-light fixed-top bg-light border-bottom">
	  	<a class="navbar-brand" href="/">
	        <img src="/static/imgs/vdj.png" alt="VDj" style="width: 1.5em" class="float-left" />
	        Visual Django
	    </a>

	    <a class="nav-link disabled" href="#">|</a>

	    <a class="navbar-brand" href="#">
	    	Project: {{project_id}}
	    </a>
	    
	    <a class="btn btn-success btn-sm" href="#" target=_new>
          Run
        </a>

	    <div class="collapse navbar-collapse" id="navbarCollapse">
	      <ul class="navbar-nav mr-auto">
	      	<li class="nav-item">
		    	<a class="nav-link disabled" href="#">|</a>
		  	</li>
	        <li class="nav-item dropdown">
			    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">File</a>
			    <div class="dropdown-menu">
			      <a class="dropdown-item" href="#">New File</a>
			      <a class="dropdown-item" href="#">Save</a>
			      <a class="dropdown-item" href="#">Save All</a>
			      <div class="dropdown-divider"></div>
			      <a class="dropdown-item" href="#">Close File</a>
			      <a class="dropdown-item" href="#">Close All Files</a>
			      <div class="dropdown-divider"></div>
			      <a class="dropdown-item" href="/">Open Project</a>
			      <a class="dropdown-item" href="/#v-pills-new">Create Project</a>
			      <div class="dropdown-divider"></div>
			      <a class="dropdown-item" href="https://docs.djangoproject.com">Django Help</a>
			    </div>
			</li>

			<li class="nav-item dropdown">
			    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Edit</a>
			    <div class="dropdown-menu">
			      <a class="dropdown-item" href="#">Undo</a>
			      <div class="dropdown-divider"></div>
			      <a class="dropdown-item" href="#">Cut</a>
			      <a class="dropdown-item" href="#">Copy</a>
			      <a class="dropdown-item" href="#">Paste</a>
			    </div>
			</li>
	        
	      </ul>

	      <form class="form-inline mt-2 mt-md-0">
	        <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
	        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
	      </form>
	    </div>
	</nav>

    <div id="navigator_column" class="col">
    	<ul class="nav nav-tabs">
		  <li class="nav-item">
		    <a class="nav-link active bg-light" role="tab">Project Navigator</a>
		  </li>
		</ul>
		<div class="card border-0">
	        <!-- https://www.jstree.com/ -->
	        <div class="card-block px-2">
		    	<div id="project_tree">
		    		<ul>
			    	{% for item, value in project_tree.items %}
			    		<li>{{item}}
			    		{% if value.items %}
							<ul>
								{% for item, value in value.items %}
			    					<li {% if value.items %}{% else %}data-path="{{value}}"{% endif %}>{{item}}
			    					{% if value.items %}
										<ul>
											{% for item, value in value.items %}
			    								<li {% if value.items %}{% else %}data-path="{{value}}"{% endif %}>{{item}}
			    								{% if value.items %}
													<ul>
														{% for item, value in value.items %}
			    											<li data-path="{{value}}">{{item}}</li>	
			    										{% endfor %}
													</ul>
												{% endif %}
												</li>
			    							{% endfor %}
										</ul>
									{% endif %}
									</li>
			    				{% endfor %}
							</ul>
						{% endif %}
						</li>
					{% endfor %}
					</ul>
				</div>
			</div>
			<!-- <div class="card-footer">
	            Edit
	        </div> -->
		</div>

    </div>
    
    <div id="center_column" class="col">
    	<!-- Editor Area -->
    	<ul class="nav nav-tabs" id="center_column_tabs" role="tablist">
		  <li class="nav-item">
		    <a href="#welcome-editor" class="nav-link active bg-light" id="welcome-tab" data-toggle="tab" role="tab" aria-controls="welcome-editor" aria-selected="true">
		    	Welcome
		    </a>
		  </li>
		  <li class="nav-item">
		    <a href="#structure-editor" class="nav-link bg-light" id="structure-tab" data-toggle="tab" role="tab" aria-controls="structure-editor">
		    	Project Structure
		    </a>
		  </li>
		</ul>
		<div class="tab-content h-100 border-left" id="center_column_tabs_content">
		  <div class="tab-pane fade show active h-100" id="welcome-editor" role="tabpanel" aria-labelledby="welcome-tab">
		  	<iframe style="height: 100%; width: 100%; border: 0" src="https://vsergeyev.github.io/django-visual/"></iframe>
		  </div>

		  <div class="tab-pane fade show active h-100 p-3" id="structure-editor" role="tabpanel" aria-labelledby="structure-tab">

		  	<img class="img-fluid" src="http://yuml.me/diagram/boring;dir:lr/class/{% for item, models in project_apps.iteritems %}[{{project_id}}]<>->[{{item}}], {% for model in models %}[{{item}}]<>->[{{model.name}}], {% endfor %}{% endfor %}" >

		  	<!--
		  	{% for item, models in project_apps.iteritems %}
		  		[{{project_id}}]<>->[{{item}}],
		  		{% for model in models %}
		  			[{{item}}]<>->[{{model.name}}]
		  		{% endfor %}	
		  	{% endfor %}
			-->

		  	<p>Diagram is drawn using <a href="https://yuml.me" target=_blank>https://yuml.me</a></p>
		  </div>

		  {% for item, models in project_apps.iteritems %}
		  	{% if 'django.contrib' in item %}

		    {% else %}
			  <div class="tab-pane fade h-100 p-3" id="model-editor-{{item}}" role="tabpanel">
			  	{% for model in models %}
				<div class="card">
					<ul class="nav nav-tabs">
					  <li class="nav-item">
					    <a class="nav-link active bg-light" role="tab">Model: {{model.name}}
					    	&nbsp;
					    	<i class="badge badge-info badge-pill float-right open-file" data-path="{{model.path}}">{{model.rel_path}}</i>
					    </a>
					  </li>
					</ul>
			        <div class="card-block px-2">
				    	<div class="list-group list-group-flush">
				    	{% for field in model.fields %}
						  <div href="#" class="list-group-item list-group-item-action">
						    {{field.name}} <span class="badge badge-info badge-pill float-right">{{field.class}}</span>
						  </div>
						{% endfor %}
						</div>
					</div>
				</div>
				{% empty %}
					<p>
						No models defiled
					</p>
				{% endfor %}
			  </div>
			{% endif %}
		  {% endfor %}
		</div>
    </div>

    <div id="properties_column" class="col">
    	
    	<div class="card">
    		<ul class="nav nav-tabs">
			  <li class="nav-item">
			    <a class="nav-link active bg-light" role="tab">Applications</a>
			  </li>
			</ul>
	        <div class="card-block px-2">
		    	<div class="list-group list-group-flush">
		    		<div class="list-group-item">
				    	django built-in

				    	<div class="dropdown float-right">
						  <button class="badge badge-info badge-pill btn btn-info dropdown-toggle btn-sm" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						    Info
						  </button>
						  <div class="dropdown-menu dropdown-menu-right">
						  	{% for item, models in project_apps.iteritems %}
		    					{% if 'django.contrib' in item %}
						    		<a class="dropdown-item small" href="#">{{item}}</a>
								{% endif %}
				    		{% endfor %}
						  </div>
						</div>
					</div>

		    	{% for item, models in project_apps.iteritems %}
		    		{% if 'django.contrib' in item %}

		    		{% else %}
					  <div class="list-group-item list-group-item-action">
					  	<a href="#" data-panel="model-editor-{{item}}" class="list-group-item-action open-model-editor">{{item}}</a>

					  	{% if models %}
					  	<div class="dropdown float-right">
					  	  <button class="badge badge-info badge-pill btn btn-info dropdown-toggle btn-sm" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						    Models
						  </button>
						  <div class="dropdown-menu dropdown-menu-right">
				  			{% for model in models %}
				    			<a class="dropdown-item small" href="#">{{model.name}}</a>
				  			{% endfor %}
						  </div>
						</div>
						{% endif %}
					  </div>
					 {% endif %}
				{% endfor %}

				<span class="list-group-item">
					<a href="#" class="badge badge-info badge-pill float-right">Edit</a>
				</span>
				</div>
			</div>
			<!-- <div class="card-footer">
	            Edit
	        </div> -->
		</div>

		<div class="card">
	        <ul class="nav nav-tabs">
			  <li class="nav-item">
			    <span class="nav-link active bg-light" role="tab">Databases</span>
			  </li>
			</ul>
	        <div class="card-block px-2">
		    	<div class="list-group list-group-flush">
		    	{% for label, item in project_databases.items %}
				  <div class="list-group-item">
				    {{label}}

					<div class="dropdown float-right">
					  <button class="badge badge-info badge-pill btn btn-info dropdown-toggle btn-sm" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					    Info
					  </button>
					  <div class="dropdown-menu dropdown-menu-right">
					  	{% for key, value in item.iteritems %} 
					    	<a class="dropdown-item small" href="#">{{key}}: {{value}}</a>
					    {% endfor %}
					  </div>
					</div>
				</div>
				{% endfor %}

				<span class="list-group-item">
					<a href="#" class="badge badge-info badge-pill float-right">Edit</a>
				</span>
				</div>
			</div>
			<!-- <div class="card-footer">
	            Edit
	        </div> -->
		</div>

		<div class="card">
	        <ul class="nav nav-tabs">
			  <li class="nav-item">
			    <span class="nav-link active bg-light" role="tab">URLs</span>
			  </li>
			</ul>
	        <div class="card-block px-2">
		    	<div class="list-group list-group-flush">
		    	{% for item in project_urls %}
				  <span class="list-group-item">
				    {{item}}
				  </span>
				{% endfor %}

				<span class="list-group-item">
					<a href="#" class="badge badge-info badge-pill float-right">Edit</a>
				</span>
				</div>
			</div>
			<!-- <div class="card-footer">
	            Edit
	        </div> -->
		</div>

    </div>
</div>

<script>
    /* JS Goes Here */
    var splitobj = Split(["#navigator_column","#center_column","#properties_column"], {
        elementStyle: function (dimension, size, gutterSize) { 
            $(window).trigger('resize'); // Optional
            return {'flex-basis': 'calc(' + size + '% - ' + gutterSize + 'px)'}
        },
        gutterStyle: function (dimension, gutterSize) { return {'flex-basis':  gutterSize + 'px'} },
        sizes: [20,60,20],
        minSize: 50,
        gutterSize: 6,
        cursor: 'col-resize'
    });

    var PROJECT_HOME =  "{{project_home}}";

    $('#project_tree').jstree().on('ready.jstree', function(){
    	$.jstree.defaults.core.multiple = false;

    	$(this).jstree('open_all');

    	$(this).on("changed.jstree", function (e, data) {
			var label = $("#" + data.selected[0]).text().trim(),
				path = $("#" + data.selected[0]).attr("data-path").trim();

			var rel_path = path.replace(PROJECT_HOME, "");

			project_tree_open_file(rel_path, path);
		});

		$(".open-model-editor").on("click", function() {
			var panel = $(this).data("panel");
			var label = $(this).text();

			if ($('#tab-' + panel).length == 0) {
				$('<li class="nav-item">'
		    	  + '<a href="#' + panel + '" class="nav-link" id="tab-' + panel + '" data-toggle="tab" role="tab" '
		    	  + 'aria-controls="' + panel + '">Application: ' + label + '</a>'
		  		  + '</li>').appendTo("#center_column_tabs");
			}

			$('#tab-' + panel).tab('show');
		});

		$("#center_column_tabs").on("click", "i.close-tab", function() {
			var panel = $(this).data("panel");
			//console.log(panel);
			$("#tab-" + panel).remove();
			$("#editor-" + panel).remove();
			$("#welcome-tab").tab("show");
		});

		$("#center_column_tabs_content").on("click", "i.open-file", function() {
			project_tree_open_file(
				$(this).text(),
				$(this).data("path")
			);
		});		

    });
</script>
{% endblock %}